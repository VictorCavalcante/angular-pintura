(function(){var a,b,c,d;d=angular.module("ngPintura",[]),a=function(){function a(){var a,d,e,f;f=new Konva.Stage({container:angular.element("<div>")[0]}),e=new Konva.Layer,a=new Konva.Image,d=new Konva.Rect,f.add(e),e.add(a),e.add(d),this.stage=f,this.layer=e,this.image=new b(a),this.indicator=new c(d)}return a.prototype.resize=function(a,b){return this.stage.size({width:a,height:b}),this.indicator.node.position({x:a/2,y:b/2}),this.image.adjustScaleBounds(this.stage.size())},a.prototype.imageChange=function(a){return this.image.node.visible(!1),this.indicator.node.visible(!0),this.indicator.animation.start(),"string"==typeof a?Konva.Image.fromURL(a,function(a){return function(b){return a.setImage(b.image()),b.destroy()}}(this)):a instanceof Image?this.setImage(a):console.log("src is not set")},a.prototype.setImage=function(a){return this.image.node.size({width:a.width,height:a.height}),this.image.node.image(a),this.indicator.node.visible(!1),this.indicator.animation.stop(),this.image.adjustScaleBounds(this.stage.size()),this.image.node.visible(!0),this.image.node.parent.draw(),this.image.node.fire(this.image.LOADED)},a}(),c=function(){function a(a){var b;this.node=a,this.rotationSpeed=270,this.node.setAttrs({width:50,height:50,fill:"pink",stroke:"white",strokeWidth:4,zIndex:99,visible:!1,offset:{x:25,y:25}}),b=function(a){return function(b){var c;return c=b.timeDiff*a.rotationSpeed/1e3,a.node.rotate(c)}}(this),this.animation=new Konva.Animation(b,this.node.parent)}return a}(),b=function(){function a(a){this.node=a,this.LOADED="loaded",this.node.draggable(!0),this.minScale=.5,this.maxScale=1,this.tween=void 0,this.tweenDuration=.25}return a.prototype.adjustScaleBounds=function(a){return this.node.width()&&this.node.height()?(this.minScale=a.width/this.node.width(),a.height<this.node.height()*this.minScale&&(this.minScale=a.height/this.node.height()),this.minScale=Math.min(this.minScale,1)):void 0},a.prototype._fitScale=function(a){return Math.min(Math.max(a,this.minScale),this.maxScale)},a.prototype._zoomToPointAttrs=function(a,b){var c,d,e;return e=this.node.scaleX()+a,e=this._fitScale(e),d=this.node.getAbsoluteTransform().copy().invert().point(b),c={x:(-d.x+b.x/e)*e,y:(-d.y+b.y/e)*e,scaleX:e,scaleY:e}},a.prototype.zoomToPoint=function(a,b){return this.node.setAttrs(this._zoomToPointAttrs(a,b)),this.node.parent.draw()},a.prototype.zoomToPointer=function(a){return this.zoomToPoint(a,this.node.getStage().getPointerPosition())},a.prototype._stageCenter=function(){var a;return a={x:this.node.getStage().width()/2,y:this.node.getStage().height()/2}},a.prototype.zoomToCenter=function(a){return this.zoomToPoint(a,this._stageCenter())},a.prototype.zoomToPointTween=function(a,b,c){var d;return d=this._zoomToPointAttrs(a,b),a!==this.node.scaleX()||d.x!==this.node.x()||d.y!==this.node.y()?(this.tween&&this.tween.pause().destroy(),this.tween=new Konva.Tween(angular.extend(d,{node:this.node,duration:this.tweenDuration,easing:Konva.Easings.EaseOut,onFinish:c})),this.tween.play()):void 0},a.prototype.zoomToCenterTween=function(a,b){return this.zoomToPointTween(a,this._stageCenter(),b)},a.prototype.moveByVectorTween=function(a,b){var c;return c=this.node.position(),a.x&&(c.x+=a.x),a.y&&(c.y+=a.y),c.x!==this.node.x()||c.y!==this.node.y()?(this.tween&&this.tween.pause().destroy(),this.tween=new Konva.Tween(angular.extend(c,{node:this.node,duration:this.tweenDuration,easing:Konva.Easings.EaseOut,onFinish:b})),this.tween.play()):void 0},a.prototype.fitInViewTween=function(a){var b,c;return c={width:this.node.width()*this.minScale,height:this.node.height()*this.minScale},b={scaleX:this.minScale,scaleY:this.minScale,x:c.width<this.node.getStage().width()?(this.node.getStage().width()-c.width)/2:0,y:c.height<this.node.getStage().height()?(this.node.getStage().height()-c.height)/2:0},b.x!==this.node.x()||b.y!==this.node.y()||b.scaleX!==this.node.scaleX()?(this.tween&&this.tween.pause().destroy(),this.tween=new Konva.Tween(angular.extend(b,{node:this.node,duration:this.tweenDuration,easing:Konva.Easings.EaseOut,onFinish:a})),this.tween.play()):void 0},a}(),d.service("ngPintura",function(){return new a}),d.directive("ngPintura",["ngPintura","$window",function(a,b){var c;return c={transclude:!0,scope:{src:"=",scaling:"=",position:"=",fitOnload:"=",maxScaling:"=",scaleStep:"=",mwScaleStep:"=",moveStep:"="},link:function(c,d,e,f,g){var h,i,j,k,l,m,n,o,p,q;return c.slider={value:void 0,fromScaling:function(b){return this.value=parseInt((b-a.image.minScale)/(a.image.maxScale-a.image.minScale)*100)},toScaling:function(){return(a.image.maxScale-a.image.minScale)*(this.value/100)+a.image.minScale}},n=function(){return a.resize(d[0].clientWidth,d[0].clientHeight),p()},i=function(){return a.imageChange(c.src)},m=function(){return a.image.node.position(c.position),a.layer.draw()},o=function(){return a.image.node.scale({x:c.scaling,y:c.scaling}),a.layer.draw(),c.slider.fromScaling(c.scaling)},l=function(b){return b.evt.preventDefault(),b.evt.wheelDeltaY>0?a.image.zoomToPointer(c.mwScaleStep):a.image.zoomToPointer(-c.mwScaleStep),h()},q=function(){return c.position=a.image.node.position(),c.scaling=a.image.node.scaleX(),c.slider.toScaling()!==c.scaling?c.slider.fromScaling(c.scaling):void 0},h=function(){return c.$apply(q)},c.fitInView=function(){return a.image.fitInViewTween(h)},c.moveUp=function(){return a.image.moveByVectorTween({y:c.moveStep},h)},c.moveDown=function(){return a.image.moveByVectorTween({y:-c.moveStep},h)},c.moveRight=function(){return a.image.moveByVectorTween({x:-c.moveStep},h)},c.moveLeft=function(){return a.image.moveByVectorTween({x:c.moveStep},h)},c.zoomIn=function(){return a.image.zoomToCenterTween(c.scaleStep,h)},c.zoomOut=function(){return a.image.zoomToCenterTween(-c.scaleStep,h)},c.sliderChange=function(){var b;return b=c.slider.toScaling()-a.image.node.scaleX(),a.image.zoomToCenter(b),q()},p=function(){return c.scalingDisabled=a.image.minScale>=a.image.maxScale},j=function(){return c.fitOnload&&c.fitInView(),p()},k=function(){return a.image.maxScale=c.maxScaling,p()},null==c.maxScaling&&(c.maxScaling=1),null==c.scaleStep&&(c.scaleStep=.4),null==c.mwScaleStep&&(c.mwScaleStep=.1),null==c.moveStep&&(c.moveStep=100),null==c.fitOnload&&(c.fitOnload=!0),d.append(a.stage.content),n(),angular.element(b).on("resize",n),c.$watch("src",i),c.$watch("position",m,!0),c.$watch("scaling",o),c.$watch("maxScaling",k),a.image.node.on("dragend",h),a.image.node.on("mousewheel",l),a.image.node.on(a.image.LOADED,j),g(c,function(a){return d.append(a)})}}}])}).call(this);